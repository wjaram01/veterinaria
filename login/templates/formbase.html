<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        
        <div class="card m-4 p-4 bg-light-cream rounded-3 shadow-lg">
            <div class="card-body">
                <form id="targetForm" action="{{request.path}}" method="post">
                    <input type="hidden" name="action" value="{{ action|default:'register' }}">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                            </label>
                            
                            {{ field }}
                            
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}

                                <div class="text-danger small mt-1" id="error_{{ field.name }}">
                                    </div>
                        </div>
                    {% endfor %}
                    
                    <div class="d-grid mt-4">
                        <a href="javascript:void(0);" id="submitBtn" class="btn btn-md px-4 bg-cream" 
                                style="border-radius: 10px; box-shadow: 0 0 20px 10px rgba(255, 255, 255, 1); color: white;">
                            Enviar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
        $('#submitBtn').on('click', function(event) {
    
        // Evita que el formulario se env√≠e de la manera tradicional
        event.preventDefault(); 
        
        const $form = $('#targetForm'); 
        const url = $form.attr('action') || window.location.href;
        
        // 1. üåü CORRECCI√ìN CLAVE: Usar FormData para incluir archivos üåü
        // Se crea un objeto FormData a partir del elemento DOM nativo ($form[0])
        const formData = new FormData($form[0]); 

        // 2. Obtiene el CSRF Token (aunque FormData a menudo lo incluye, es buena pr√°ctica tenerlo)
        const csrftoken = $form.find('input[name="csrfmiddlewaretoken"]').val();
        
        // 3. Env√≠a la solicitud POST usando jQuery.ajax()
        $.ajax({
            type: 'POST',
            url: url,
            
            // üåü CORRECCI√ìN 2: Enviar el objeto FormData
            data: formData, 
            
            // üåü CORRECCI√ìN 3: Le dice a jQuery que NO procese los datos (necesario para FormData)
            processData: false, 
            
            // üåü CORRECCI√ìN 4: Le dice a jQuery que NO establezca Content-Type 
            // (FormData lo hace autom√°ticamente como multipart/form-data)
            contentType: false, 
            
            headers: {
                'X-CSRFToken': csrftoken, // Incluye el CSRF token
            },
            dataType: 'json', 
            
            success: function(response) {
                if (response.result) {
                    Swal.fire({
                        title: "¬°√âxito!",
                        text: response.message || "Guardado correctamente.",
                        icon: "success", 
                        showCancelButton: false,
                        confirmButtonText: "Aceptar"
                    }).then((result) => {
                        // Redirecci√≥n si se confirma el √©xito
                        if (result.isConfirmed) {
                            // Redirige a la URL proporcionada por el servidor o a la actual
                            window.location.href = response.to || window.location.href;
                        }
                    });
                } else {
                    if (response.form) {
                        // Limpia errores previos
                        $('.text-danger').html('');
                        
                        // Muestra errores espec√≠ficos del formulario
                        for (const [field, errors] of Object.entries(response.form)) {
                            const errorHtml = errors.map(error => `<p>${error}</p>`).join('');
                            $(`#error_${field}`).html(errorHtml);
                        }
    
                    } else {
                        Swal.fire("Error", response.message || 'Error desconocido al guardar.', "error");
                    }
                }
            },
            
            error: function(xhr, status, error) {
                // Manejo de Errores detallado
                console.error("Error al enviar el formulario:", status, error);
                
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    console.error("Detalles del error de Django:", errorData);
                    
                    // Mostrar un mensaje de error m√°s espec√≠fico
                    const errorMessage = errorData.message || errorData.mensaje || 'Ocurri√≥ un error en el servidor.';
                    Swal.fire("Error en la Petici√≥n", errorMessage, "error");
                    
                } catch (e) {
                    Swal.fire("Error Desconocido", "Ocurri√≥ un error al procesar la solicitud.", "error");
                }
            }
        });
    });
});
</script>