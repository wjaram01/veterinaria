<div class="row justify-content-center">
    <div class="col">
        
        <div class="card m-4 p-4 bg-light-cream rounded-3 shadow-lg">
            <div class="card-body">
                <form id="targetForm" action="{{request.path}}" method="post">
                    <input type="hidden" name="action" value="{{ action|default:'register' }}">
                    <input type="hidden" name="id" value="{{ id }}">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                            </label>
                            
                            {{ field }}
                            
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}

                                <div class="text-danger small mt-1" id="error_{{ field.name }}">
                                    </div>
                        </div>
                    {% endfor %}
                    <input type="hidden" id="id_prediccion" name="prediccion" value="">
                    
                    <div class="d-grid mt-4">
                        <a href="javascript:void(0);" id="submitBtn" class="btn btn-md px-4 bg-cream" 
                                style="border-radius: 10px; box-shadow: 0 0 20px 10px rgba(255, 255, 255, 1); color: white;">
                            Enviar
                        </a>
                    </div>
                    <div class="d-grid mt-4">
                        <a href="javascript:void(0);" id="submitBtn1" class="btn btn-md px-4 bg-cream" 
                                style="border-radius: 10px; box-shadow: 0 0 20px 10px rgba(255, 255, 255, 1); color: white;">
                            Guardar.
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
    <div class="row card m-4 p-6 mt-6 p-4 bg-light-cream rounded-3">
        <div class="col-12 text-center mt-4">
            <div class="mx-4">
                <p id="prediccion"><p>
                <p id="confianza"><p>
            </div>
            <div class="row">
                <div id="image"><div>
            </div>
        </div>
    </div>

<script>
$(document).ready(function() {
        $('#submitBtn1').hide()
        $('#submitBtn').on('click', function(event) {
    
        // Evita que el formulario se env칤e de la manera tradicional
        event.preventDefault(); 
        
        const $form = $('#targetForm'); 
        const url = $form.attr('action') || window.location.href;
        
        // 1. 游 CORRECCI칍N CLAVE: Usar FormData para incluir archivos 游
        // Se crea un objeto FormData a partir del elemento DOM nativo ($form[0])
        const formData = new FormData($form[0]); 

        // 2. Obtiene el CSRF Token (aunque FormData a menudo lo incluye, es buena pr치ctica tenerlo)
        const csrftoken = $form.find('input[name="csrfmiddlewaretoken"]').val();
        
        // 3. Env칤a la solicitud POST usando jQuery.ajax()
        $.ajax({
            type: 'POST',
            url: url,
            
            // 游 CORRECCI칍N 2: Enviar el objeto FormData
            data: formData, 
            
            // 游 CORRECCI칍N 3: Le dice a jQuery que NO procese los datos (necesario para FormData)
            processData: false, 
            
            // 游 CORRECCI칍N 4: Le dice a jQuery que NO establezca Content-Type 
            // (FormData lo hace autom치ticamente como multipart/form-data)
            contentType: false, 
            
            headers: {
                'X-CSRFToken': csrftoken, // Incluye el CSRF token
            },
            dataType: 'json', 
            
            success: function(response) {
                if (response.result) {
                    $('#confianza').text(`Confianza: ${response.data.confianza}`)
                    $('#prediccion').text(`Predicci칩n: ${response.data.prediccion}`)
                    $('#id_prediccion').val(response.data.prediccion)

                    $('#submitBtn1').show()
                    $('#image').html(`<img 
                                class="imagen-base64" 
                                src="${response.data.imagen}"
                                width="500px"
                                height="500px"
                                alt="Descripci칩n de la imagen Base64">`)
                } else {
                    if (response.form) {
                        // Limpia errores previos
                        $('.text-danger').html('');
                        
                        // Muestra errores espec칤ficos del formulario
                        for (const [field, errors] of Object.entries(response.form)) {
                            const errorHtml = errors.map(error => `<p>${error}</p>`).join('');
                            $(`#error_${field}`).html(errorHtml);
                        }
    
                    } else {
                        Swal.fire("Error", response.message || 'Error desconocido al guardar.', "error");
                    }
                }
            },
            
            error: function(xhr, status, error) {
                // Manejo de Errores detallado
                console.error("Error al enviar el formulario:", status, error);
                
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    console.error("Detalles del error de Django:", errorData);
                    
                    // Mostrar un mensaje de error m치s espec칤fico
                    const errorMessage = errorData.message || errorData.mensaje || 'Ocurri칩 un error en el servidor.';
                    Swal.fire("Error en la Petici칩n", errorMessage, "error");
                    
                } catch (e) {
                    Swal.fire("Error Desconocido", "Ocurri칩 un error al procesar la solicitud.", "error");
                }
            }
        });
    });
      $('#submitBtn1').on('click', function(event) {
    
        // Evita que el formulario se env칤e de la manera tradicional
        event.preventDefault(); 
        
        const $form = $('#targetForm'); 
        const url = window.location.href;
        
        // 1. 游 CORRECCI칍N CLAVE: Usar FormData para incluir archivos 游
        // Se crea un objeto FormData a partir del elemento DOM nativo ($form[0])
        const formData = new FormData($form[0]);
        formData.append('action', 'saveconsulta');

        // 2. Obtiene el CSRF Token (aunque FormData a menudo lo incluye, es buena pr치ctica tenerlo)
        const csrftoken = $form.find('input[name="csrfmiddlewaretoken"]').val();
        
        // 3. Env칤a la solicitud POST usando jQuery.ajax()
        $.ajax({
            type: 'POST',
            url: url,
            
            // 游 CORRECCI칍N 2: Enviar el objeto FormData
            data: formData, 
            
            // 游 CORRECCI칍N 3: Le dice a jQuery que NO procese los datos (necesario para FormData)
            processData: false, 
            
            // 游 CORRECCI칍N 4: Le dice a jQuery que NO establezca Content-Type 
            // (FormData lo hace autom치ticamente como multipart/form-data)
            contentType: false, 
            
            headers: {
                'X-CSRFToken': csrftoken, // Incluye el CSRF token
            },
            dataType: 'json', 
            
            success: function(response) {
                if (response.result) {
                    Swal.fire({
                        title: "춰칄xito!",
                        text: response.message || "Guardado correctamente.",
                        icon: "success", 
                        showCancelButton: false,
                        confirmButtonText: "Aceptar"
                    }).then((result) => {
                        // Redirecci칩n si se confirma el 칠xito
                        if (result.isConfirmed) {
                            location.reload()
                        }
                    });
                } else {
                    if (response.form) {
                        // Limpia errores previos
                        $('.text-danger').html('');
                        
                        // Muestra errores espec칤ficos del formulario
                        for (const [field, errors] of Object.entries(response.form)) {
                            const errorHtml = errors.map(error => `<p>${error}</p>`).join('');
                            $(`#error_${field}`).html(errorHtml);
                        }
    
                    } else {
                        Swal.fire("Error", response.message || 'Error desconocido al guardar.', "error");
                    }
                }
            },
            
            error: function(xhr, status, error) {
                // Manejo de Errores detallado
                console.error("Error al enviar el formulario:", status, error);
                
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    console.error("Detalles del error de Django:", errorData);
                    
                    // Mostrar un mensaje de error m치s espec칤fico
                    const errorMessage = errorData.message || errorData.mensaje || 'Ocurri칩 un error en el servidor.';
                    Swal.fire("Error en la Petici칩n", errorMessage, "error");
                    
                } catch (e) {
                    Swal.fire("Error Desconocido", "Ocurri칩 un error al procesar la solicitud.", "error");
                }
            }
        });
    });
});
</script>